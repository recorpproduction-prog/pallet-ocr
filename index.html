<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pallet OCR Capture</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body {
        background: #0e0e0e;
        color: #ffffff;
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 20px;
      }
      h2 { margin-bottom: 15px; }

      video {
        width: 100%;
        max-width: 420px;
        aspect-ratio: 9 / 16;
        object-fit: cover;
        border-radius: 12px;
        background: #000;
      }

      canvas { display: none; }

      button {
        background: #28a745;
        color: white;
        margin-top: 15px;
        padding: 14px 26px;
        font-size: 18px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
      }

      #status { margin-top: 15px; min-height: 22px; font-size: 16px; }

      #rawTextBox {
        margin-top: 15px;
        width: 100%;
        max-width: 480px;
        height: 140px;
        font-size: 12px;
        font-family: monospace;
      }
    </style>
  </head>

  <body>

    <h2>Pallet OCR Capture (Portrait Mode)</h2>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <button id="captureBtn">Capture, OCR & Upload</button>

    <div id="status"></div>
    <textarea id="rawTextBox" readonly></textarea>

    <script>
      const BACKEND_URL = "https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbwktfY1vKrlRq18sw19uglvn6ScVVUqWazyqrriooc9ZC52XvpUdlGPntKTwNMKz7rZ/exec";

      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const rawBox = document.getElementById("rawTextBox");
      const statusEl = document.getElementById("status");

      let cameraReady = false;


      /************************************************************
       * TRIPLE CAMERA-READY FIX
       ************************************************************/

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      // FIX 1: Request camera with portrait constraints
      navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          aspectRatio: 9/16,
          width: { ideal: 720 },
          height: { ideal: 1280 }
        }
      })
      .then(stream => {
        video.srcObject = stream;

        // FIX 2: Metadata event
        video.addEventListener("loadedmetadata", () => {
          console.log("loadedmetadata fired");
          
          // FIX 3: Delay to ensure stable width/height
          setTimeout(() => {
            if (video.videoWidth > 0 && video.videoHeight > 0) {
              cameraReady = true;
              setStatus("Camera ready.");
            }
          }, 250);
        });

        // FIX 4: Some phones only fire 'playing'
        video.addEventListener("playing", () => {
          console.log("playing fired");
          if (video.videoWidth > 0 && video.videoHeight > 0) {
            cameraReady = true;
            setStatus("Camera ready.");
          }
        });

      })
      .catch(err => setStatus("Camera error: " + err.message));



      /************************************************************
       * PARSE OCR TEXT
       ************************************************************/
      function parseFields(t) {
        t = t.replace(/\r/g, "").replace(/[ \t]+\n/g, "\n");
        const p = r => (t.match(r) || ["", ""])[1].trim();

        return {
          itemNumber:  p(/Item\s*Number[:\s]*([^\n]+)/i),
          description: p(/Item\s*Description[:\s]*([\s\S]*?)\n(?:Batch|Date|EAN|SSCC|Quantity)/i),
          batchNo:     p(/Batch.*?[:\-]?\s*([A-Za-z0-9\-]+)/i),
          ean:         p(/EAN.*?Number[:\s]*([^\n]+)/i).replace(/[^0-9]/g,""),
          sscc:        p(/SSCC[:\s]*([^\n]+)/i).replace(/[^0-9]/g,""),
          quantity:    p(/Quantity.*?(\d+)/i),
          labelDate:   p(/Date[:\s]*([0-9\/\-]+)/i),
          labelTime:   p(/Time[:\s]*([0-9:]+)/i),
          status:      "OK"
        };
      }



      /************************************************************
       * CAPTURE + OCR + UPLOAD
       ************************************************************/
      async function capture() {

        // HARD CHECK: video must be live
        if (!cameraReady || video.videoWidth === 0 || video.videoHeight === 0) {
          setStatus("Camera loading… Hold phone still 1–2s.");
          return;
        }

        setStatus("Capturing...");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0);

        // Preprocess for better OCR
        const tmp = document.createElement("canvas");
        const tctx = tmp.getContext("2d");
        tmp.width = canvas.width * 2;
        tmp.height = canvas.height * 2;

        tctx.filter = "grayscale(100%) contrast(150%) brightness(130%)";
        tctx.drawImage(canvas, 0, 0, tmp.width, tmp.height);

        const dataURL = tmp.toDataURL("image/jpeg");
        const base64 = dataURL.split(",")[1];

        setStatus("OCR scanning...");
        const result = await Tesseract.recognize(dataURL, "eng");
        const rawText = result.data.text || "";
        rawBox.value = rawText;

        const fields = parseFields(rawText);

        setStatus("Uploading...");

        const r = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            imageBase64: base64,
            mimeType: "image/jpeg",
            rawText,
            fields
          })
        });

        const j = await r.json();

        if (j.ok) setStatus("Uploaded ✔");
        else setStatus("Server error: " + j.error);
      }

      document.getElementById("captureBtn").onclick = capture;

    </script>

  </body>
</html>
